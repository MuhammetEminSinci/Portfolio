// √úr√ºn verisi
const products = [
  { id: 1, name: "Kablosuz Kulaklƒ±k", price: 799, image: "../../images/product1.jpg", description: "Y√ºksek kaliteli ses deneyimi ile konfor bir arada.", category: "Elektronik" },
  { id: 2, name: "Bluetooth Hoparl√∂r", price: 599, image: "../../images/product2.jpg", description: "Partiler i√ßin m√ºkemmel ses √ßƒ±kƒ±≈üƒ± ve ta≈üƒ±nabilirlik.", category: "Elektronik" },
  { id: 3, name: "Gaming Mouse", price: 349, image: "../../images/product3.jpg", description: "RGB ƒ±≈üƒ±klƒ±, y√ºksek hassasiyetli oyuncu faresi.", category: "Aksesuar" },
  { id: 4, name: "LED Monit√∂r", price: 1899, image: "../../images/product4.jpg", description: "Full HD √ß√∂z√ºn√ºrl√ºk, 75Hz yenileme hƒ±zƒ±.", category: "Bilgisayar" }
];

// Sepet verisi (localStorage'dan y√ºkle ya da bo≈ü array)
let cart = JSON.parse(localStorage.getItem("cart")) || [];

// DOM elementleri
const productList = document.getElementById("product-list");
const categoryFilter = document.getElementById("category-filter");
const searchInput = document.getElementById("search-input");

const darkModeToggle = document.getElementById("dark-mode-toggle");

const cartBtn = document.getElementById("cart-btn");
const cartCount = document.getElementById("cart-count");
const cartModal = document.getElementById("cart-modal");
const cartItemsContainer = document.getElementById("cart-items");
const clearCartBtn = document.getElementById("clear-cart-btn");
const checkoutBtn = document.getElementById("checkout-btn");

const productModal = document.getElementById("product-modal");
const modalCloseButtons = document.querySelectorAll(".modal-close");

const addToCartBtn = document.getElementById("add-to-cart-btn");

const checkoutModal = document.getElementById("checkout-modal");
const checkoutForm = document.getElementById("checkout-form");
const paymentMessage = document.getElementById("payment-message");

let currentProductId = null;

// Tema Y√∂netimi
function loadTheme() {
  const theme = localStorage.getItem("theme") || "dark";
  if (theme === "light") {
    document.body.classList.add("light");
    darkModeToggle.textContent = "üåô";
    darkModeToggle.setAttribute("aria-pressed", "true");
  } else {
    document.body.classList.remove("light");
    darkModeToggle.textContent = "‚òÄÔ∏è";
    darkModeToggle.setAttribute("aria-pressed", "false");
  }
}

function toggleTheme() {
  if (document.body.classList.contains("light")) {
    document.body.classList.remove("light");
    localStorage.setItem("theme", "dark");
    darkModeToggle.textContent = "‚òÄÔ∏è";
    darkModeToggle.setAttribute("aria-pressed", "false");
  } else {
    document.body.classList.add("light");
    localStorage.setItem("theme", "light");
    darkModeToggle.textContent = "üåô";
    darkModeToggle.setAttribute("aria-pressed", "true");
  }
}

// √úr√ºnlarƒ± DOM'a ekle
function renderProducts(list) {
  productList.innerHTML = "";
  if (list.length === 0) {
    productList.innerHTML = "<p>Aradƒ±ƒüƒ±nƒ±z √ºr√ºn bulunamadƒ±.</p>";
    return;
  }
  list.forEach((product) => {
    const card = document.createElement("article");
    card.className = "product-card";
    card.setAttribute("tabindex", "0");
    card.setAttribute("data-category", product.category);

    card.innerHTML = `
      <img src="${product.image}" alt="${product.name}" loading="lazy" />
      <h3>${product.name}</h3>
      <p class="price">‚Ç∫${product.price.toFixed(2)}</p>
      <button aria-label="${product.name} √ºr√ºn√ºn√º sepete ekle" data-id="${product.id}">Sepete Ekle</button>
    `;

    // √úr√ºn kartƒ±na tƒ±klayƒ±nca detay modal a√ß
    card.addEventListener("click", (e) => {
      // Eƒüer butona basƒ±ldƒ±ysa zaten ekleme yapacak, sadece detay modal a√ßma.
      if (e.target.tagName === "BUTTON") return;
      openProductModal(product.id);
    });

    productList.appendChild(card);
  });
}

// √úr√ºn detay modalƒ±nƒ± a√ß
function openProductModal(id) {
  currentProductId = id;
  const product = products.find((p) => p.id === id);
  if (!product) return;

  document.getElementById("modal-image").src = product.image;
  document.getElementById("modal-image").alt = product.name;
  document.getElementById("product-modal-title").textContent = product.name;
  document.getElementById("modal-description").textContent = product.description;
  document.getElementById("modal-price").textContent = `Fiyat: ‚Ç∫${product.price.toFixed(2)}`;

  productModal.classList.remove("hidden");
  productModal.focus();
}

// Modal kapatma
modalCloseButtons.forEach((btn) =>
  btn.addEventListener("click", () => {
    closeAllModals();
  })
);

function closeAllModals() {
  productModal.classList.add("hidden");
  cartModal.classList.add("hidden");
  checkoutModal.classList.add("hidden");
  paymentMessage.classList.remove("visible");
  checkoutForm.reset();
}

// Sepete ekle
function addToCart(id) {
  const product = products.find((p) => p.id === id);
  if (!product) return;
  const cartItem = cart.find((item) => item.id === id);
  if (cartItem) {
    cartItem.quantity++;
  } else {
    cart.push({ ...product, quantity: 1 });
  }
  saveCart();
  renderCart();
  updateCartCount();
}

// Sepeti DOM'a render et
function renderCart() {
  cartItemsContainer.innerHTML = "";
  if (cart.length === 0) {
    cartItemsContainer.innerHTML = "<li>Sepetiniz bo≈ü.</li>";
    document.getElementById("total-price").textContent = "‚Ç∫0";
    return;
  }
  let total = 0;
  cart.forEach((item) => {
    total += item.price * item.quantity;

    const li = document.createElement("li");
    li.innerHTML = `
      <div>
        <strong>${item.name}</strong> x ${item.quantity}
      </div>
      <div>
        <button aria-label="√úr√ºn√º azalt" data-id="${item.id}" class="decrease">‚àí</button>
        <button aria-label="√úr√ºn√º artƒ±r" data-id="${item.id}" class="increase">+</button>
        <button aria-label="Sepetten √ßƒ±kar" data-id="${item.id}" class="remove">√ó</button>
      </div>
    `;
    cartItemsContainer.appendChild(li);
  });
  document.getElementById("total-price").textContent = `‚Ç∫${total.toFixed(2)}`;

  // Butonlara event baƒüla
  cartItemsContainer.querySelectorAll(".decrease").forEach((btn) =>
    btn.addEventListener("click", (e) => {
      const id = parseInt(e.target.dataset.id);
      changeQuantity(id, -1);
    })
  );
  cartItemsContainer.querySelectorAll(".increase").forEach((btn) =>
    btn.addEventListener("click", (e) => {
      const id = parseInt(e.target.dataset.id);
      changeQuantity(id, 1);
    })
  );
  cartItemsContainer.querySelectorAll(".remove").forEach((btn) =>
    btn.addEventListener("click", (e) => {
      const id = parseInt(e.target.dataset.id);
      removeFromCart(id);
    })
  );
}

function changeQuantity(id, delta) {
  const item = cart.find((i) => i.id === id);
  if (!item) return;
  item.quantity += delta;
  if (item.quantity < 1) {
    removeFromCart(id);
  } else {
    saveCart();
    renderCart();
    updateCartCount();
  }
}

function removeFromCart(id) {
  cart = cart.filter((i) => i.id !== id);
  saveCart();
  renderCart();
  updateCartCount();
}

function saveCart() {
  localStorage.setItem("cart", JSON.stringify(cart));
}

function updateCartCount() {
  let count = 0;
  cart.forEach((item) => (count += item.quantity));
  cartCount.textContent = count;
  cartCount.setAttribute("aria-label", `${count} adet √ºr√ºn sepette`);
}

// Sepet modal a√ß/kapa
cartBtn.addEventListener("click", () => {
  const expanded = cartBtn.getAttribute("aria-expanded") === "true";
  if (expanded) {
    cartModal.classList.add("hidden");
    cartBtn.setAttribute("aria-expanded", "false");
  } else {
    renderCart();
    cartModal.classList.remove("hidden");
    cartBtn.setAttribute("aria-expanded", "true");
    cartModal.focus();
  }
});

// Sepete ekle butonlarƒ± event delegation ile
productList.addEventListener("click", (e) => {
  if (e.target.tagName === "BUTTON") {
    const id = parseInt(e.target.dataset.id);
    addToCart(id);
  }
});

// Modal sepete ekle butonu
addToCartBtn.addEventListener("click", () => {
  if (currentProductId !== null) {
    addToCart(currentProductId);
    productModal.classList.add("hidden");
  }
});

// Kategori filtrele
categoryFilter.addEventListener("change", () => {
  filterProducts();
});

// Arama input
searchInput.addEventListener("input", () => {
  filterProducts();
});

function filterProducts() {
  const category = categoryFilter.value;
  const searchTerm = searchInput.value.toLowerCase();

  let filtered = products.filter((p) => {
    const matchCategory = category === "all" || p.category === category;
    const matchSearch = p.name.toLowerCase().includes(searchTerm);
    return matchCategory && matchSearch;
  });

  renderProducts(filtered);
}

// Temayƒ± toggle et
darkModeToggle.addEventListener("click", toggleTheme);

// Sepeti temizle
clearCartBtn.addEventListener("click", () => {
  if (confirm("Sepeti bo≈üaltmak istediƒüinize emin misiniz?")) {
    cart = [];
    saveCart();
    renderCart();
    updateCartCount();
    cartModal.classList.add("hidden");
    cartBtn.setAttribute("aria-expanded", "false");
  }
});

// Checkout modal a√ß
checkoutBtn.addEventListener("click", () => {
  if (cart.length === 0) {
    alert("Sepetiniz bo≈ü!");
    return;
  }
  cartModal.classList.add("hidden");
  checkoutModal.classList.remove("hidden");
  checkoutModal.focus();
});

// √ñdeme formu g√∂nderme
checkoutForm.addEventListener("submit", (e) => {
  e.preventDefault();
  // Basit validasyon
  if (!checkoutForm.checkValidity()) {
    checkoutForm.reportValidity();
    return;
  }

  paymentMessage.textContent = "√ñdemeniz ba≈üarƒ±lƒ±! Te≈üekk√ºrler.";
  paymentMessage.classList.add("visible");

  // Sepeti temizle ve modalƒ± kapat
  cart = [];
  saveCart();
  updateCartCount();

  setTimeout(() => {
    checkoutModal.classList.add("hidden");
    paymentMessage.classList.remove("visible");
  }, 3000);
});

// ƒ∞lk render ve tema y√ºkle
loadTheme();
renderProducts(products);
updateCartCount();
